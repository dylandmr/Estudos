<div class="breadcrumbs">
    <div class="col-sm-4">
        <div class="page-header float-left">
            <div class="page-title">
                <h1>Gerenciar produtos</h1>
            </div>
        </div>
    </div>
    <div class="col-sm-8">
        <div class="page-header float-right">
            <div class="page-title">
                <ol class="breadcrumb text-right">
                    <li><a href="/Home/Index">Dashboard</a></li>
                    <li><a href="/Produto/Index">Produtos</a></li>
                </ol>
            </div>
        </div>
    </div>
</div>
<div class="content mt-3">
    <div class="animated fadeIn">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <strong class="card-title">Produtos</strong>
                    </div>
                    <div class="card-body">
                        <div id="mensagensContainer"></div>
                        <table id="bootstrap-data-table" class="table table-striped table-hover table-bordered tab">
                            <thead>
                                <tr>
                                    <th>Id</th>
                                    <th>Subcategoria.CategoriaId</th>
                                    <th>SubcategoriaId</th>
                                    <th>PrecoRecarga</th>
                                    <th>PrecoTroca</th>
                                    <th>MarcaId</th>
                                    <th>Nome</th>
                                    <th>Preço(s)</th>
                                    <th>Marca</th>
                                    <th>Estoque</th>
                                    <th>Categoria - Subcategoria</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- .animated -->
</div><!-- .content -->

@Scripts.Render("~/bundles/tables/js")

<script src="/Content/js/vendor/jquery.form.min.js"></script>
<script src="~/Content/js/jquery.mask.js"></script>

<script>
    $('#precoUnitarioAdd').mask("#.##0,00", { reverse: true });
    $('#precoUnitarioEditar').mask("#.##0,00", { reverse: true });

    function apagaProduto() {
        var dados = $('#bootstrap-data-table').DataTable().rows('.selected').data();
        var params = { id: dados[0].Id };
        $.post("/Produto/Desativa", params, atualizaPagina);
    }

    function atualizaPagina(resposta) {
        if (resposta.apagou == true) {
            $('#fechaModalRemover').click(); $('#fechaModalRemover').click();
            $('#bootstrap-data-table').DataTable().ajax.reload();
            $("#mensagensContainer").append(
                '<div class="col-sm-12" id="msgProdutoRemovido">'
                    +'<div class="sufee-alert alert with-close alert-danger alert-dismissible fade show">'
                        +'<span class="badge badge-pill badge-danger">sucesso</span> Produto removido.'
                                +'<button type="button" class="close" data-dismiss="alert" aria-label="Close">'
                            +'<span aria-hidden="true">&times;</span>'
                        +'</button>'
                    +'</div>'
                +'</div>');
        }
    }

    function pegaDados() {
        var dados = $('#bootstrap-data-table').DataTable().rows('.selected').data();
        $('#dialogoDesativar').text("Deseja realmente remover " + dados[0].Nome + "?");
    }

    $('#FormAdiciona').ajaxForm({
        success: function () {
            $('#fechaModalAdd').click(); $('#fechaModalAdd').click();
            $('#bootstrap-data-table').DataTable().ajax.reload();
            $("#mensagensContainer").append(
                '<div class="col-sm-12" id="msgProdutoAdicionado">'
                    +'<div class="alert  alert-success alert-dismissible fade show" role="alert">'
                        +'<span class="badge badge-pill badge-success">sucesso</span> Produto adicionado.'
                                +'<button type="button" class="close" data-dismiss="alert" aria-label="Close">'
                            +'<span aria-hidden="true">&times;</span>'
                        +'</button>'
                    +'</div>'
                +'</div>');
        }
    });

    $('#FormAtualiza').ajaxForm({
        success: function () {
            $('#fechaModalEdita').click(); $('#fechaModalEdita').click();
            $('#bootstrap-data-table').DataTable().ajax.reload();
            $("#mensagensContainer").append(
              '<div class="col-sm-12" id="msgProdutoAtualizado">'
                + '<div class="sufee-alert alert with-close alert-warning alert-dismissible fade show">'
                    + '<span class="badge badge-pill badge-warning">sucesso</span> Produto atualizado.'
                    + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">'
                        + '<span aria-hidden="true">&times;</span>'
                    + '</button>'
                + '</div>'
            + '</div>');
        }
    });

    $.getJSON("/Produto/getCategorias", null, function (data) {
        $.each(data.Categorias, function (index, item) {
            $("#categoriaAdd").append(
                $("<option></option>")
                    .text(item.Nome)
                    .val(item.Id)
            );
            $("#categoriaEditar").append(
                $("<option></option>")
                    .text(item.Nome)
                    .val(item.Id)
            );
        });
    });

    $.getJSON("/Produto/getMarcas", null, function (data) {
        $.each(data.Marcas, function (index, item) {
            $("#MarcaAdd").append(
                $("<option></option>")
                    .text(item.Nome)
                    .val(item.Id)
            );
            $("#MarcaEditar").append(
                $("<option></option>")
                    .text(item.Nome)
                    .val(item.Id)
            );
        });
    });

    function pegaSubcategorias(form) {
        var categoriaId = $("#categoria" + form).val();
        if (categoriaId == 0) {
            $("#subcategoria" + form + " option").remove();
            $("#subcategoria" + form).prop("disabled", true);
            $("#subcategoria" + form).append(
                $("<option></option>")
                    .text("Selecione...")
                    .val("")
            );
        }
        else {
            $.getJSON("/Produto/getSubcategorias/" + categoriaId, null, function (data) {
                $("#subcategoria" + form + " option").remove();
                $("#subcategoria" + form).prop("disabled", false);
                $("#subcategoria" + form).append(
                    $("<option></option>")
                        .text("Selecione...")
                        .val("")
                );
                $.each(data.Subcategorias, function (index, item) {
                    $("#subcategoria" + form).append(
                        $("<option></option>")
                            .text(item.Nome)
                            .val(item.Id)
                    );
                    if (form == 'Editar') {
                        var dados = $('#bootstrap-data-table').DataTable().rows('.selected').data();
                        $("#subcategoria" + form).val(dados[0].SubcategoriaId).change();
                    }
                });
            });
        }
    }

    function verificaPrecos(form) {
        var categoriaId = $("#categoria" + form).val();
        var subcategoriaId = $("#subcategoria" + form).val();
        if (categoriaId == 2 && subcategoriaId == 6) {
            $("#precoTroca" + form).prop("disabled", false);
            $("#precoRecarga" + form).prop("disabled", false);
            $("#precoTrocaDiv" + form).prop("hidden", false);
            $("#precoRecargaDiv" + form).prop("hidden", false);
        } else {
            $("#precoTroca" + form).prop("disabled", true);
            $("#precoRecarga" + form).prop("disabled", true);
            $("#precoTrocaDiv" + form).prop("hidden", true);
            $("#precoRecargaDiv" + form).prop("hidden", true);
        }
    }

    function populaEditar() {
        var dados = $('#bootstrap-data-table').DataTable().rows('.selected').data();
        $('#IdEditar').val(dados[0].Id);
        $('#nomeEditar').val(dados[0].Nome);
        $('#estoqueEditar').val(dados[0].Estoque);
        $('#precoUnitarioEditar').val(dados[0].PrecoUnitario);
        $('#MarcaEditar').val(dados[0].MarcaId);
        $('#categoriaEditar').val(dados[0].Subcategoria.CategoriaId).change();
        if (dados[0].PrecoRecarga != null) {
            $('#precoRecargaEditar').val(dados[0].PrecoRecarga);
        }
        if (dados[0].PrecoTroca != null) {
            $('#precoTrocaEditar').val(dados[0].PrecoTroca);
        }
    }
</script>

<div class="modal fade" id="ModalRemover" tabindex="-1" role="dialog" aria-labelledby="smallmodalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="smallmodalLabel">Desativar produto</h5>
                <button type="button" id="fechaModalRemover" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="dialogoDesativar"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="apagaProduto()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ModalAdicionar" tabindex="-1" role="dialog" aria-labelledby="largeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="largeModalLabel">Adicionar Produto</h5>
                <button type="button" id="fechaModalAdd" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body card-block">
                            <form action="/Produto/Adiciona" method="post" id="FormAdiciona">
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Nome</div>
                                        <input type="text" id="nomeAdd" name="produto.Nome" minlength="5" maxlength="50" required class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Marca</div>
                                        <select name="produto.MarcaId" id="MarcaAdd" required class="form-control">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Categoria</div>
                                        <select name="categoriaId" id="categoriaAdd" required onchange="pegaSubcategorias('Add'), verificaPrecos('Add')" class="form-control">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Subcategoria</div>
                                        <select name="produto.SubcategoriaId" id="subcategoriaAdd" required onchange="verificaPrecos('Add')" disabled class="form-control">
                                            <option value="">Selecione...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Estoque inicial</div>
                                        <input type="number" id="estoqueAdd" min="1" value="0" max="100" required name="produto.Estoque" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Preço unitário</div>
                                        <div class="input-group-addon">R$</div>
                                        <input type="text" step="0.01" min="1" value="0" id="precoUnitarioAdd" required name="produto.PrecoUnitario" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group" id="precoRecargaDivAdd" hidden>
                                    <div class="input-group">
                                        <div class="input-group-addon">Preço recarga</div>
                                        <div class="input-group-addon">R$</div>
                                        <input type="number" step="0.01" min="1" value="1" id="precoRecargaAdd" name="produto.PrecoRecarga" disabled class="form-control">
                                    </div>
                                </div>
                                <div class="form-group" id="precoTrocaDivAdd" hidden>
                                    <div class="input-group">
                                        <div class="input-group-addon">Preço troca</div>
                                        <div class="input-group-addon">R$</div>
                                        <input type="number" step="0.01" min="1" value="1" id="precoTrocaAdd" name="produto.PrecoTroca" disabled class="form-control">
                                    </div>
                                </div>
                                <div class="form-actions form-group text-center">
                                    <button type="submit" class="btn btn-primary">Cadastrar produto</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ModalEditar" tabindex="-1" role="dialog" aria-labelledby="largeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="largeModalLabelEditar">Editar Produto</h5>
                <button type="button" id="fechaModalEdita" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body card-block">
                            <form action="/Produto/Atualiza" method="post" id="FormAtualiza">
                                <input type="text" id="IdEditar" name="produto.Id" hidden class="form-control">
                                <input type="text" name="produto.Ativo" value="true" hidden class="form-control">
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Nome</div>
                                        <input type="text" id="nomeEditar" name="produto.Nome" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Marca</div>
                                        <select name="produto.MarcaId" id="MarcaEditar" class="form-control">
                                            <option value="0">Selecione...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Categoria</div>
                                        <select name="categoriaId" id="categoriaEditar" onchange="pegaSubcategorias('Editar'), verificaPrecos('Editar')" class="form-control">
                                            <option value="0">Selecione...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Subcategoria</div>
                                        <select name="produto.SubcategoriaId" id="subcategoriaEditar" onchange="verificaPrecos('Editar')" disabled class="form-control">
                                            <option value="0">Selecione...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Estoque inicial</div>
                                        <input type="number" id="estoqueEditar" min="1" value="1" max="100" name="produto.Estoque" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="input-group">
                                        <div class="input-group-addon">Preço unitário</div>
                                        <input type="text" step="0.01" min="1" value="1" id="precoUnitarioEditar" pattern="^\\$?(([1-9](\\d*|\\d{0,2}(,\\d{3})*))|0)(\\.\\d{1,2})?$" name="produto.PrecoUnitario" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group" id="precoRecargaDivEditar" hidden>
                                    <div class="input-group">
                                        <div class="input-group-addon">Preço recarga</div>
                                        <div class="input-group-addon">R$</div>
                                        <input type="number" step="0.01" min="1" value="1" id="precoRecargaEditar" name="produto.PrecoRecarga" disabled class="form-control">
                                    </div>
                                </div>
                                <div class="form-group" id="precoTrocaDivEditar" hidden>
                                    <div class="input-group">
                                        <div class="input-group-addon">Preço troca</div>
                                        <div class="input-group-addon">R$</div>
                                        <input type="number" step="0.01" min="1" value="1" id="precoTrocaEditar" name="produto.PrecoTroca" disabled class="form-control">
                                    </div>
                                </div>
                                <div class="form-actions form-group text-center">
                                    <button type="submit" class="btn btn-primary">Salvar alterações</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>